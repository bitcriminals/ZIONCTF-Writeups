/* You have found the SOURCE CODE ! */

const express = require('express')
var logger = require('morgan')
const path = require('path')
const fs = require('fs')
const app = express()
const port = 13000

const sqlite3 = require('sqlite3').verbose();
const db = new sqlite3.Database('accounts.db');

const { body, validationResult } = require('express-validator');
const { dirname } = require('path')

app.use(express.json());
app.use(express.urlencoded({extended: true}));
app.use(express.static(path.join(__dirname, '.')))
app.use(logger('common'))

app.get('/', (req, res) => {
    // console.log(`GET / ${req.socket.remoteAddress} ${req.headers['x-forwarded-for']}`)
  res.send(`<html>
<head><title>ZionCTF | eXamine-Search-Sabotage</title>
<style>
body { margin : 5rem; text-align: center; }
body > * { margin: auto; }
td { display:block; padding: 0.2rem; }
pre {display:inline !important; background-color:#bbb !important;}
</style>
</head>
<body>
<h1>Log In / Register</h1>
<form action="/page" method="POST">
<table style="margin:auto;"><tbody><tr><td><label for="username">Username</label></td>
<td><input type="text" name="username" id="username" max="50" required/></td></tr>
<tr><td><label for="password">Password</label></td>
<td><input type="password" name="password" id="password" max="50" required/></td></tr>
<tr><td><input type="submit"/></td></tr></tbody></table>
<input type="hidden" name="view-source" value="false"/>
</form>
</body>
</html>
  `)
})

app.get('/page', (req, res)=>{
    res.redirect('/')
})
app.get('/view', (req, res)=>{
    res.redirect('/')
})

app.post('/page', body('username').escape().isLength({ max: 50}),
                  body('password').escape().isLength({ max: 50 }), (req, res) => {
    try {
        const errors = validationResult(req);
        if (!errors.isEmpty()) {
            msg = `<html><head>
                    <title>ZionCTF |  eXamine-Search-Sabotage</title>
                    <style>
                    body { margin : 5rem; }
                    td { display:block; padding: 0.2rem; }
                    pre {display:inline !important; background-color:#ddd !important;}
                    </style>
                    </head>`;
            for (let err of errors.array())
                msg += `<p>Unacceptable value <pre><code>${err.value}</code></pre> for field <pre><code>${err.param}</code></pre></p>`;
            msg += `<div><a href="/">Back to Login</a></div></html>`;
            return res.status(400).send(msg);
        }
        if (req.body['view-source'] === 'true') {
	    res.cookie('ZionCTFHint1', 'source_code_is_in_/index.js', {maxAge:60})
            res.cookie('ZionCTFHint2', 'photos_are_in_1_level_deep_subfolder_/images/', {maxAge:60})
        }
        db.get(`SELECT password FROM users WHERE username='${req.body.username}'`, function(err,row) {
            if (row !== undefined) {
                if (row['password']!==req.body.password) {
                    res.send(`<html>
                    <head><title>ZionCTF | eXamine-Search-Sabotage</title>
                    <style>
                    body { margin : 5rem; text-align: center; }
                    body > * { margin: auto; }
                    td { display:block; padding: 0.2rem; }
                    pre {display:inline !important; background-color:#bbb !important;}
                    </style>
                    </head><body>
                    <h1>Log In / Register</h1>
                    <form action="/page" method="POST">
                    <table style="margin:auto;"><tbody><tr><td><label for="username">Username</label></td>
                    <td><input type="text" name="username" id="username" max="50" required/></td></tr>
                    <tr><td><label for="password">Password</label></td>
                    <td><input type="password" name="password" id="password" max="50" required/><br><span style="color:red;">Incorrect Password</span></td></tr>
                    <tr><td><input type="submit"/></td></tr></tbody></table>
                    <input type="hidden" name="view-source" value="false"/>
                    </form></body></html>`)
                } else {
                    res.send(`<html>
                    <head>
                    <title>ZionCTF | eXamine-Search-Sabotage</title>
                    <style>
                    body { margin : 5rem; }
                    </style>
                    </head><body>
                    <h1>Welcome, ${req.body.username} !</h1>
                    <p>Taken over by wanderlust ? Here are the top 10 regions (worldwide) to visit in 2022 according to Lonely Planet</p>
                    <p style="color: #bbb;">*Note : Photographs are from the lonely planet website and their copyrights apply.</p>
                    <p> Select an image to view : </p>
                    <form action="/view" method="POST">
                    <select name="file" id="file"><option>Westfjords.png</option>
                    <option>West Virginia.png</option><option>Xishuangbanna.png</option><option>Kent's Heritage Coast.png</option>
                    <option>Puerto Rico.png</option><option>Shikoku.png</option><option>Atacama Desert.png</option>
                    <option>The Scenic Rim.png</option><option>Vancouver Island.png</option><option>Burgundy.png</option></select>
                    <input type="submit"/></form>
                    </body>
                    </html>`)
                }
            } else {
                db.run(`INSERT INTO users VALUES("${req.body.username}", "${req.body.password}")`)
                res.send(`<html>
                <head>
                <title>ZionCTF | eXamine-Search-Sabotage</title>
                <style>
                body { margin : 5rem; }
                </style>
                </head><body>
                <h1>Welcome, ${req.body.username} !</h1>
                <p style="color:green;">Your account has been created</p>
                <p>Taken over by wanderlust ? Here are the top 10 regions (worldwide) to visit in 2022 according to Lonely Planet</p>
                <p style="color: #888;">*Note : The photographs are from the lonely planet website and their copyrights apply.</p>
                <p> Select an image to view : </p>
                <form action="/view" method="POST">
                <select name="file" id="file"><option>Westfjords.png</option>
                <option>West Virginia.png</option><option>Xishuangbanna.png</option><option>Kent's Heritage Coast.png</option>
                <option>Puerto Rico.png</option><option>Shikoku.png</option><option>Atacama Desert.png</option>
                <option>The Scenic Rim.png</option><option>Vancouver Island.png</option><option>Burgundy.png</option></select>
                <input type="submit"/></form>
                </body>
                </html>`)
            }
        })
    } catch (exception) {
        console.log(exception)
        res.status(500).send("Oops, an unexpected error occurred!")
    }
})

app.post('/view', (req, res)=>{
    try {
        let addr = path.join(__dirname, 'images', req.body.file)
        if (fs.existsSync(addr)) {
            //if (Number((addr.match(/\.\.\//g) || []).length < 2) {
            if (addr.startsWith(__dirname)) {
                res.sendFile(addr);
            } else {
                res.status(404).send(`Nice try! But not quite there yet... `)
            }
        } else {
            res.status(404).send(`Nice try! But not quite there yet... `)
        }
    } catch (exception) {
        res.status(500).send("Oops, an unexpected error occurred!")
    }
})

app.listen(port, () => {
  console.log(`ZionCTF : eXamine-Search-Sabotage listening on port ${port}`)
})